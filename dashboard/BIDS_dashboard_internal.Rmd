---
params:
  df: "DataFrame"
  study: "StudyInfo"
  wd: "working_dir"
  pattern_to_remove: "pattern"
title: "`r params$study`"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill

---

```{r setup, include=FALSE}
library(flexdashboard)
library(rjson)
library(DT)
library(plotly)
library(knitr)
library(ggplot2)

source("dashboard_functions.R")

knitr::opts_knit$set(root.dir = params$wd)
```

```{r}
metadata_dataset <- fromJSON(file = "sourcedata/dataset_description.json")

params_df <- params$df %>%
  mutate(sequence_BIDS = as.factor(sequence_BIDS),
           PatientSex = as.factor(PatientSex),
           session = as.factor(session),
           type = as.factor(type),
           group_BIDS = as.factor(group_BIDS))
```

Summary
===========================================================================

Raw infos {data-width=200}
--------------------------------------------------------------------------

### Overview

#### Subjects 
`r params$df %>% select(subject) %>% unique() %>% count() %>% kable()`
#### Sessions
`r params$df %>% count(session)  %>% kable()` 
#### Sequences
`r params$df %>% count(relevant)  %>% kable()`
#### Relevant
`r params$df %>% filter(relevant == 1) %>% count(sequence)  %>% kable()`  
#### Irrelevant
`r params$df %>% filter(relevant == 0) %>% count(sequence)  %>% kable()`
#### Scanner information
`r params$df %>% count(ManufacturersModelName)  %>% kable()`  
`r params$df %>% count(Modality)   %>% kable()`  
`r params$df %>% count(MagneticFieldStrength)   %>% kable()` 
`r params$df %>% count(DeviceSerialNumber)   %>% kable()`  
`r params$df %>% count(SoftwareVersions)   %>% kable()`  
`r params$df %>% count(StationName) %>% kable()` 
`r params$df %>% count(InstitutionalDepartmentName)  %>% kable()`  
`r params$df %>% count(InstitutionName)  %>% kable()`  
 

Study Summary {data-width=450}
-----------------------------------------------------------------------

### Dataset Information

__Authors:__ `r metadata_dataset$Authors`  
__Funding:__ `r metadata_dataset$Funding`  
__How to acknowledge:__ `r metadata_dataset$HowToAcknowledge`  
__License__: `r metadata_dataset$License`  
__References and Links:__ `r metadata_dataset$ReferencesAndLinks`  
__BIDS Version:__ `r metadata_dataset$BIDSVersion`  


### Chart A

```{r}
diagnostics$json_data %>% 
    df_select_n %>% 
  plot_bar() 
```

Column {data-width=350}
-----------------------------------------------------------------------

### Relevant sequences

```{r}
params_df %>% 
  df_select_n() %>%
  filter(relevant == 1) %>% select(-relevant) %>%
  spread(. ,session, value = n) %>%
  datatable_setting()
```

### Irrelevant sequences

```{r}
params_df %>% 
  df_select_n() %>%
  filter(relevant == 0) %>% select(-relevant) %>%
  spread(. ,session, value = n) %>%
  datatable_setting()
```

Group-summary
=================================================================

Column {data-width=700}
---------------------------------------------
### Group plot

```{r}
p <-params_df %>%
    df_select_n_group() %>% 
    ggplot(aes(x = group_BIDS, y = n, fill = PatientSex)) + 
    geom_bar(position="stack", stat = "identity") + 
    theme_minimal() +
    facet_grid(session ~ sequence_BIDS) +
    ggtitle("Barplots of n=Sequence , split by session-id and group-id") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p) %>% layout(margin = list(l = 100, r = 100, b = 100, t = 100))

```

Column {data-widht=300}
--------------------------------------------------

### Group table

```{r}
params_df %>% 
    df_select_n_group() %>% 
  select(-relevant) %>%
  spread(session, n) %>%
  datatable_setting()
```

Subjects-summary
==============================================================

Column {data-width=1000}
---------------------------------------------------------------

### All
```{r}

sessions <- params_df$session %>% n_distinct()



params_df  %>%
  calculate_comp_subjects() %>%
  datatable_setting()


```


Age-distribution
========================================================================

Column {data-width=550}
--------------------------------------------------

### Boxplots split by gender


```{r out.width=2}

params_df %>% 
   df_select_patient_info() %>% 
   ggplot(aes(x = PatientSex, y = Age, fill = PatientSex)) +
   geom_flat_violin(aes(fill = PatientSex), position = position_nudge(x = .25, y = 0), 
                       adjust = .5, trim = FALSE, alpha = .5) +
  geom_point(position = position_jitter(width = .15), size = .25, alpha = 0.25) +
  geom_boxplot(aes(x = PatientSex, y = Age, fill = PatientSex),
               position = position_nudge(x = .15, y = 0),
               outlier.shape = NA, alpha = .5, width = .5, colour = "black") +
   facet_grid(group_BIDS ~ session, scales = "free") +
   ggtitle("Boxplots of Age and Sex, split by session-id and group-id") +
 coord_flip() +
  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1))
```

Column {data-width=450}
--------------------------------------------------

### Statistics

```{r}
params_df %>% 
  df_select_patient_info() %>%
  group_by(session, PatientSex, group_BIDS) %>% 
  summarize(mean = mean(Age),
            median = median(Age),
            sd = sd(Age),
            var = var(Age),
            iqr = IQR(Age),
            n = n()) %>%
  select(session, PatientSex, n, everything()) %>%
  mutate_if(is.numeric, round, digits = 2) %>%
  datatable_setting()
```

Weight-distribution
========================================================================

Column {data-width=550}
--------------------------------------------------

### Boxplots split by gender

```{r out.width=0.5}
params_df %>% 
   df_select_patient_info() %>% 
   ggplot(aes(x = PatientSex, y = PatientWeight, fill = PatientSex)) +
  geom_flat_violin(aes(fill = PatientSex), position = position_nudge(x = .25, y = 0), 
                       adjust = .5, trim = FALSE, alpha = .5) +
  geom_point(position = position_jitter(width = .15), size = .25, alpha = 0.25) +
  geom_boxplot(aes(x = PatientSex, y = PatientWeight, fill = PatientSex),
               position = position_nudge(x = .15, y = 0),
               outlier.shape = NA, alpha = .5, width = .5, colour = "black") +
   facet_grid(group_BIDS ~ session, scales = "free") +
   ggtitle("Boxplots of Weight and Sex, split by session-id and group-id") +
 coord_flip() +
  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1))
```

Column {data-width=450}
--------------------------------------------------

### Statistics

```{r}
params_df %>% 
  df_select_patient_info() %>%
  group_by(session, PatientSex, group_BIDS) %>% 
  summarize(mean = mean(PatientWeight),
            median = median(PatientWeight),
            sd = sd(PatientWeight),
            var = var(PatientWeight),
            iqr = IQR(PatientWeight),
            n = n()) %>%
  mutate_if(is.numeric, round, digits = 2) %>%
  select(session, PatientSex, n, everything()) %>%
  datatable_setting()
```


QC: Subject data
=================================================================

Column {data-width=1000}
-----------------------

### JSON Metadata

```{r}
params_df %>% 
  filter(relevant == 1) %>%
  df_select_patient_info2() %>%
  unique() %>%
  datatable_setting()
```

QC: Metadata
===========================================================================

These tables could indicate implausibilities (like errors in ID), based on entrys, that contain sensitive information on the subject.  

Column {data.width = 500}
--------------------------------------------------------

### ID changes - Shapeshifters

```{r}
clean_string <- function(input, pattern) {
  library(stringr)
  input %>%
    str_remove_all(pattern) %>%
    str_remove_all("[:punct:]+") %>%
    str_remove_all(regex(params$pattern_to_remove, ignore_case = TRUE))
}



params_df %>%
  select(session, subject, PatientID, PatientName) %>%
  mutate(
    subject = str_remove(subject, "sub-"),
    PatientID = clean_string(PatientID, subject),
    PatientName = clean_string(PatientName, subject)
  ) %>%
  filter(PatientID != "" | PatientName != "") %>%
  unique() %>%
  datatable_setting()
```

### Birthdata changes - Reincarnated

```{r}
params_df %>%
  select(subject, PatientBirthDate) %>%
  unique() %>%
  count(subject) %>% filter(n > 1) %>%
  left_join(params$df) %>%
  select(subject, session, AcquisitionDateTime, PatientBirthDate) %>%
  mutate(AcquisitionDateTime = as.Date(AcquisitionDateTime)) %>%
  unique() %>%
  group_by(subject) %>%
  mutate(
    Age = difftime(AcquisitionDateTime, PatientBirthDate) %>% time_length("years") %>% round(1),
    BirthDateDiff = difftime(PatientBirthDate, lag(PatientBirthDate)) %>% time_length("years") %>% round(1)
  ) %>%
  datatable_setting()

```

Column {data.width = 500}
-----------------------------------------------------------

### Sex changes - Clownfishes

```{r}
params_df %>%
  select(subject, PatientSex) %>%
  unique() %>%
  count(subject) %>% filter(n > 1) %>%
  left_join(params$df) %>%
  select(subject, session, PatientSex) %>% unique() %>%
  datatable_setting()
      
    
  
```

### Two acquisition dates at same session id - Time travellers

```{r}
params_df %>%
  select(subject, session, AcquisitionDateTime) %>%
  mutate(AcquisitionDateTime = as.Date(AcquisitionDateTime)) %>%
  unique() %>%
  group_by(subject) %>%
  count(session) %>% filter(n > 1) %>%
  datatable_setting()
```

QC: Sequence selection
===========================================================================

```{r}
params_df %>%
  select(type, relevant, sequence, SeriesDescription, ProtocolName) %>%
  group_by_all() %>%
  count() %>%
  select(type, relevant, n, everything()) %>%
  datatable_setting()


```

QC: Duplicates
==========================================================================

```{r}
params_df %>%
  filter(relevant == 1) %>%
  select(subject, session, sequence_BIDS) %>% 
  group_by_all () %>% 
  count() %>% 
  filter(n > 1) %>%
  left_join(params$df) %>% 
  select(subject, session, sequence, input_json, BIDS_json) %>% 
  unique() %>%
  datatable_setting()
```

QC: Settings - anat
===================================================================================

```{r}
params_df %>%
  filter(type == "anat") %>%
  filter(relevant == "1") %>%
  mutate(sequence_BIDS = as.factor(sequence_BIDS)) %>%
  show_settings() %>%
  datatable_setting()
  
```

QC: Settings - dwi
===================================================================================

```{r}
params_df %>%
  filter(type == "dwi") %>%
  filter(relevant == "1") %>%
  mutate(sequence_BIDS = as.factor(sequence_BIDS)) %>%
  show_settings() %>%
  datatable_setting()
  
```

QC: Settings - func
===================================================================================

```{r}
params_df %>%
  filter(type == "func") %>%
  filter(relevant == "1") %>%
  mutate(sequence_BIDS = as.factor(sequence_BIDS)) %>%
  show_settings() %>%
  datatable_setting()
  
```